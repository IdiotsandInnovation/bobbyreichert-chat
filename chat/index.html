<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat | Bobby Reichert</title>
    <link rel="icon" type="image/x-icon" href="faviconchat.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #475569;
        }
        /* Mobile height fix for Safari */
        @supports (-webkit-touch-callout: none) {
            .h-screen {
                height: -webkit-fill-available;
            }
        }
        /* Video Mirroring for Local User */
        #localVideo {
            transform: scaleX(-1);
        }
        
        /* Video Grid Layouts */
        .video-grid {
            display: grid;
            gap: 1rem;
            width: 100%;
            height: 100%;
        }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .grid-3 > :first-child { grid-column: 1 / -1; } /* First video takes full width on top */
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(auto-fit, minmax(0, 1fr));
            }
            .grid-3 > :first-child { grid-column: auto; }
        }
        
        /* Fade in animation for scroll button */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script type="module">
        // CLOUDINARY CONFIGURATION
        const CLOUDINARY_CLOUD_NAME = "drmmnimpw";
        const CLOUDINARY_UPLOAD_PRESET = "bobbyreichert-chat";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, onSnapshot, query, where, orderBy, updateDoc, arrayUnion, arrayRemove, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

        
        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyA9GsP72R_43JW7rG8Dpvcvt_n2FbQe5SM",
            authDomain: "bobbyreichert-chat.firebaseapp.com",
            projectId: "bobbyreichert-chat",
            storageBucket: "bobbyreichert-chat.firebasestorage.app",
            messagingSenderId: "743766854322",
            appId: "1:743766854322:web:a492e9eb137d903a7b17ab",
            measurementId: "G-H5ZNQ9L4ME"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // APP ID
        const APP_ID = "chat-v1"; 

        // STATE
        let currentUser = null;
        let currentChatId = null;
        let currentChatParticipants = []; // Store participants for @mentions
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        let unsubscribeChatMetadata = null;
        
        // NOTIFICATION STATE
        let isCurrentChatMuted = false;

        // EDIT/REPLY STATE
        let replyingToMessage = null;
        let editingMessage = null;
        // FILE UPLOAD STATE
        let selectedFile = null;
        
        // --- CALL STATE (GROUP SUPPORT) ---
        let peerConnections = {}; // Map: userId -> RTCPeerConnection
        let localStream = null;
        let remoteStreams = {}; // Map: userId -> MediaStream
        let currentCallId = null;
        let unsubscribeSignals = null;
        let unsubscribeCallMeta = null;
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let isScreenSharing = false;

        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
            iceCandidatePoolSize: 10,
        };

        // DOM ELEMENTS
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const rootElement = document.documentElement;
        
        const replyPanel = document.getElementById('reply-panel');
        const replyContent = document.getElementById('reply-content');
        const previewPanel = document.getElementById('preview-panel');
        const previewContent = document.getElementById('preview-content');
        const messageInput = document.getElementById('message-input');
        const progressBar = document.getElementById('upload-progress-bar');
        const progressContainer = document.getElementById('upload-progress-container');
        const notificationBtn = document.getElementById('toggle-notifications-btn');
        const messagesContainer = document.getElementById('messages-container');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');


        // --- AUTH FUNCTIONS ---

        window.handleLogin = async (e) => {
            e.preventDefault();
            
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            const btn = e.target.querySelector('button');

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Signing In...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error(error);
                errorMsg.textContent = "Invalid email or password.";
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
            }
        }

        window.handleLogout = () => {
            signOut(auth);
            document.getElementById('sidebar-view').classList.remove('hidden');
            document.getElementById('chat-view-container').classList.add('hidden');
            document.getElementById('chat-view-container').classList.remove('flex');
        }

        // --- USER PROFILE & DATA ---

        async function ensureUserProfile(user) {
            const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid);
            const snap = await getDoc(userRef);

            if (!snap.exists()) {
                await setDoc(userRef, {
                    email: user.email,
                    username: user.email.split('@')[0],
                    theme: 'light',
                    uid: user.uid,
                    photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${user.email.substring(0,2)}&background=random`
                });
                return 'light';
            } else {
                const data = snap.data();
                if (data.email !== user.email) {
                    await updateDoc(userRef, { email: user.email });
                }
                return data.theme || 'light';
            }
        }
        
        async function getDisplayName(uid) {
            try {
                const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', uid);
                const snap = await getDoc(userRef);
                if (snap.exists()) return snap.data().username || "User";
            } catch (e) { console.error(e); }
            return "User";
        }
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
              .then(reg => console.log('Service Worker Registered!'))
              .catch(err => console.log('Registration Failed', err));
          });
        }
        async function registerServiceWorker() {
          if (!('serviceWorker' in navigator)) return;
        
          try {
            const registration = await navigator.serviceWorker.register(
              '/firebase-messaging-sw.js'
            );
            console.log('[FCM] Service Worker registered');
            return registration;
          } catch (e) {
            console.error('[FCM] SW registration failed', e);
          }
        }

        async function updateUserProfile(updates) {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid);
            await updateDoc(userRef, updates);
        }
        
        // --- CHAT LOGIC ---

        function initChatListener() {
            const chatsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats');
            const q = query(chatsRef, where('userIds', 'array-contains', currentUser.uid), orderBy('updatedAt', 'desc'));

            unsubscribeChats = onSnapshot(q, (snapshot) => {
                const chatList = document.getElementById('chat-list');
                chatList.innerHTML = '';

                if (snapshot.empty) {
                    chatList.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">No chats yet.<br>Create one to get started!</div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const chat = docSnap.data();
                    const chatId = docSnap.id;
                    
                    const otherEmails = chat.participants ? chat.participants.filter(p => p.email !== currentUser.email).map(p => p.username || p.email.split('@')[0]).join(', ') : "Unknown";
                    const displayName = chat.name || otherEmails || "New Chat";
                    
                    // Check for mention
                    const isMentioned = chat.mentions && chat.mentions[currentUser.uid];
                    
                    const div = document.createElement('div');
                    // Add conditional styling for mentions (Yellow border/bg)
                    const activeClass = currentChatId === chatId ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700';
                    const mentionClass = isMentioned ? 'border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20' : '';
                    
                    div.className = `p-3 rounded-lg cursor-pointer flex items-center gap-3 transition-colors ${activeClass} ${mentionClass}`;
                    div.onclick = () => loadChat(chatId, chat);
                    
                    div.innerHTML = `
                        <div class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold flex-shrink-0 relative">
                            ${displayName.substring(0,1).toUpperCase()}
                            ${isMentioned ? '<span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span></span>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <h3 class="font-medium text-gray-900 dark:text-gray-100 truncate">${displayName}</h3>
                                ${chat.updatedAt ? `<span class="text-xs text-gray-400">${new Date(chat.updatedAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                ${isMentioned ? '<span class="text-yellow-600 font-bold">@You </span>' : ''}
                                ${chat.lastMessage || 'No messages yet'}
                            </p>
                        </div>
                    `;
                    chatList.appendChild(div);
                });
            });
        }

        window.createNewChat = async () => {
            const emailInput = document.getElementById('new-chat-email');
            const email = emailInput.value.trim();
            if (!email) return;

            showToast("Searching for user...", "info");

            const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
            const q = query(usersRef, where('email', '==', email));
            const querySnapshot = await getDocs(q);

            let targetUser = null;
            if (!querySnapshot.empty) {
                targetUser = querySnapshot.docs[0].data();
            } else {
                showToast("User not found. They must login once first.", "error");
                return;
            }

            if (targetUser.uid === currentUser.uid) {
                showToast("You can't chat with yourself.", "error");
                return;
            }

            const chatData = {
                userIds: [currentUser.uid, targetUser.uid],
                participants: [
                    { email: currentUser.email, uid: currentUser.uid, username: currentUser.displayName || currentUser.email.split('@')[0] },
                    { email: targetUser.email, uid: targetUser.uid, username: targetUser.username || targetUser.email.split('@')[0] }
                ],
                mutedUserIds: [],
                mentions: {}, // Initialize mentions map
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: "Chat created"
            };

            try {
                const docRef = await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats'), chatData);
                
                // Add System Message for Creation
                const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', docRef.id, 'messages');
                await addDoc(messagesRef, {
                    content: `${currentUser.displayName || currentUser.email.split('@')[0]} created the chat`,
                    type: 'system',
                    createdAt: serverTimestamp()
                });

                closeModal('new-chat-modal');
                emailInput.value = '';
                loadChat(docRef.id, chatData);
            } catch (e) {
                console.error(e);
                showToast("Error creating chat.", "error");
            }
        }

        window.addUserToChat = async () => {
            if (!currentChatId) return;
            
            const emailInput = document.getElementById('add-user-email');
            const email = emailInput.value.trim();
            if (!email) return;

            const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
            const q = query(usersRef, where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showToast("User not found.", "error");
                return;
            }

            const newUser = querySnapshot.docs[0].data();
            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
            const chatSnap = await getDoc(chatRef);
            const chatData = chatSnap.data();

            if (chatData.userIds.includes(newUser.uid)) {
                showToast("User already in chat.", "error");
                return;
            }

            const updatedParticipants = [...chatData.participants, {
                email: newUser.email, 
                uid: newUser.uid, 
                username: newUser.username || newUser.email.split('@')[0]
            }];

            await updateDoc(chatRef, {
                userIds: arrayUnion(newUser.uid),
                participants: updatedParticipants,
                lastMessage: `${currentUser.displayName || "User"} added ${newUser.username}`
            });
            
            // Add System Message
            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
            await addDoc(messagesRef, {
                content: `${currentUser.displayName || "User"} added ${newUser.username}`,
                type: 'system',
                createdAt: serverTimestamp()
            });

            closeModal('add-user-modal');
            emailInput.value = '';
            showToast("User added!", "success");
        }
        
        window.openRenameModal = () => {
            if (!currentChatId) return;
            const currentName = document.getElementById('chat-header-name').textContent;
            document.getElementById('rename-chat-input').value = currentName;
            openModal('rename-chat-modal');
        }

        window.renameChat = async () => {
            if (!currentChatId) return;

            const newName = document.getElementById('rename-chat-input').value.trim();
            if (!newName) {
                showToast("Chat name cannot be empty.", "error");
                return;
            }

            try {
                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                await updateDoc(chatRef, {
                    name: newName,
                    updatedAt: serverTimestamp()
                });
                
                // Add System Message
                const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                await addDoc(messagesRef, {
                    content: `${currentUser.displayName || "User"} renamed the chat to "${newName}"`,
                    type: 'system',
                    createdAt: serverTimestamp()
                });

                closeModal('rename-chat-modal');
                showToast("Chat renamed!", "success");
            } catch (e) {
                console.error("Rename error", e);
                showToast("Failed to rename chat.", "error");
            }
        }

        window.toggleChatMute = async () => {
            if (!currentChatId) return;

            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
            const action = isCurrentChatMuted ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid);
            const toastMsg = isCurrentChatMuted ? "Notifications enabled" : "Notifications muted";

            try {
                await updateDoc(chatRef, {
                    mutedUserIds: action
                });
                showToast(toastMsg, "success");
            } catch (e) {
                console.error("Mute error", e);
                showToast("Failed to update settings", "error");
            }
        }

        function updateMuteButtonUI() {
            const btn = document.getElementById('toggle-notifications-btn');
            if (isCurrentChatMuted) {
                btn.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>`;
                btn.title = "Unmute Chat";
            } else {
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>`;
                btn.title = "Mute Chat";
            }
        }

        // --- SCROLL LOGIC ---
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        messagesContainer.addEventListener('scroll', () => {
            const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
            if (isAtBottom) {
                scrollToBottomBtn.classList.add('hidden');
            } else {
                scrollToBottomBtn.classList.remove('hidden');
            }
        });

        window.scrollToBottomManual = () => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        // --- MOBILE VIEW LOGIC ---
        window.openMobileChat = () => {
            const sidebar = document.getElementById('sidebar-view');
            const chatView = document.getElementById('chat-view-container');
            
            sidebar.classList.add('hidden', 'md:flex'); 
            sidebar.classList.remove('flex'); 
            
            chatView.classList.remove('hidden');
            chatView.classList.add('flex');
        }

        window.closeMobileChat = () => {
            const sidebar = document.getElementById('sidebar-view');
            const chatView = document.getElementById('chat-view-container');
            
            sidebar.classList.remove('hidden');
            sidebar.classList.add('flex');
            
            chatView.classList.add('hidden');
            chatView.classList.remove('flex');
            currentChatId = null;
        }

        function renderDateDivider(dateStr, container) {
             const div = document.createElement('div');
             div.className = "flex items-center justify-center my-6 opacity-70";
             div.innerHTML = `
                 <div class="bg-gray-200 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-xs font-medium px-4 py-1 rounded-full border border-gray-300 dark:border-gray-700 shadow-sm">
                     ${dateStr}
                 </div>
             `;
             container.appendChild(div);
        }

        function loadChat(chatId, chatData) {
            currentChatId = chatId;
            // Clear mentions for self when opening chat
            if (chatData && chatData.mentions && chatData.mentions[currentUser.uid]) {
                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId);
                updateDoc(chatRef, {
                    [`mentions.${currentUser.uid}`]: false 
                });
            }
            
            const items = document.getElementById('chat-list').children;
            for(let item of items) {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-900');
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');

            cancelEdit();
            cancelReply();
            cancelAttachment();
            
            openMobileChat();

            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeChatMetadata) unsubscribeChatMetadata();

            const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId);
            unsubscribeChatMetadata = onSnapshot(chatRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if (currentChatId === chatId) {
                        closeMobileChat(); 
                        document.getElementById('chat-interface').classList.add('hidden');
                        document.getElementById('empty-state').classList.remove('hidden');
                        showToast("This chat was deleted.", "info");
                    }
                    return;
                }
                const data = docSnap.data();
                currentChatParticipants = data.participants || [];
                
                const displayName = data.name || (data.participants 
                    ? data.participants.filter(p => p.uid !== currentUser.uid).map(p => p.username || p.email.split('@')[0]).join(', ')
                    : "Chat");
                document.getElementById('chat-header-name').textContent = displayName;

                const mutedUsers = data.mutedUserIds || [];
                isCurrentChatMuted = mutedUsers.includes(currentUser.uid);
                updateMuteButtonUI();
            });

            let isChatInitialLoad = true;
            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('createdAt', 'asc'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                let lastDate = null;

                snapshot.forEach(doc => {
                    const msg = doc.data();
                    
                    // --- DATE DIVIDER LOGIC ---
                    let msgDate = "Today"; 
                    if (msg.createdAt) {
                        const date = msg.createdAt.toDate();
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (date.toDateString() === today.toDateString()) {
                            msgDate = "Today";
                        } else if (date.toDateString() === yesterday.toDateString()) {
                            msgDate = "Yesterday";
                        } else {
                            msgDate = date.toLocaleDateString([], {weekday: 'short', month: 'short', day: 'numeric'}); // e.g., Mon, Jan 1
                        }
                    }

                    if (msgDate !== lastDate) {
                        renderDateDivider(msgDate, container);
                        lastDate = msgDate;
                    }
                    
                    renderMessage(msg, doc.id, container);
                });
                
                if (isChatInitialLoad) {
                    scrollToBottom();
                } else {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const msg = change.doc.data();
                            const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 150;
                            if (isNearBottom || msg.senderId === currentUser.uid) {
                                scrollToBottom();
                            }
                            
                            if (!isCurrentChatMuted && msg.senderId !== currentUser.uid && msg.type !== 'system' && msg.type !== 'action') {
                                sendNotification(msg);
                            }
                        }
                    });
                }
                
                isChatInitialLoad = false;
            });
        }

        // --- ATTACHMENT / REPLY / EDIT LOGIC STAYS SAME ---
        window.setReplyTarget = (messageId, senderName, content) => {
            if (editingMessage) cancelEdit(); 
            const sanitizedContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            replyingToMessage = { id: messageId, senderName: senderName, content: content };
            replyContent.innerHTML = `Replying to **${senderName}**: ${sanitizedContent.length > 50 ? sanitizedContent.substring(0, 50) + '...' : sanitizedContent}`;
            replyPanel.classList.remove('hidden');
            messageInput.focus();
        }

        window.cancelReply = () => {
            replyingToMessage = null;
            replyPanel.classList.add('hidden');
            replyContent.innerHTML = '';
        }
        
        window.setEditTarget = (messageId, content) => {
            if (replyingToMessage) cancelReply(); 
            editingMessage = { id: messageId };
            messageInput.value = content;
            document.getElementById('send-button-icon').style.display = 'none';
            document.getElementById('edit-button-icon').style.display = 'block';
            document.getElementById('cancel-edit-button').style.display = 'block';
            messageInput.focus();
        }

        window.cancelEdit = () => {
            editingMessage = null;
            messageInput.value = '';
            document.getElementById('send-button-icon').style.display = 'block';
            document.getElementById('edit-button-icon').style.display = 'none';
            document.getElementById('cancel-edit-button').style.display = 'none';
        }

        window.handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            previewPanel.classList.remove('hidden');
            const isImage = file.type.startsWith('image/');
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewContent.innerHTML = `<div class="relative group"><img src="${e.target.result}" class="h-20 w-auto rounded border border-gray-300 dark:border-gray-600"></div><span class="text-xs text-gray-500 mt-1 block max-w-[150px] truncate">${file.name}</span>`;
                }
                reader.readAsDataURL(file);
            } else {
                previewContent.innerHTML = `<div class="h-20 w-20 flex items-center justify-center bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600"><svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div><span class="text-xs text-gray-500 mt-1 block max-w-[150px] truncate">${file.name}</span>`;
            }
            e.target.value = ''; 
        }

        window.cancelAttachment = () => {
            selectedFile = null;
            previewPanel.classList.add('hidden');
            previewContent.innerHTML = '';
        }

        // --- GROUP VIDEO CALL LOGIC (Mesh Topology) ---
        
        async function getLocalStream() {
            if (localStream) return localStream;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                return localStream;
            } catch (err) {
                console.error("Media Error:", err);
                showToast("Could not access camera/microphone", "error");
                throw err;
            }
        }

        window.startVideoCall = async () => {
            if (!currentChatId) return;
            
            // 1. Create Call Document
            const callsCollection = collection(db, 'artifacts', APP_ID, 'public', 'data', 'calls');
            const callDocRef = await addDoc(callsCollection, { 
                chatId: currentChatId,
                status: 'active',
                participants: [currentUser.uid], // Start with self
                createdAt: serverTimestamp()
            });
            currentCallId = callDocRef.id;

            // 2. Notify Chat
            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
            await addDoc(messagesRef, {
                content: "Group call started",
                type: 'call',
                callId: currentCallId,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || currentUser.email.split('@')[0],
                createdAt: serverTimestamp()
            });

            await joinCall(currentCallId);
        }

        window.joinCall = async (callId) => {
            currentCallId = callId;
            document.getElementById('call-modal').classList.remove('hidden');
            
            // 1. Get Local Stream
            try {
                await getLocalStream();
            } catch (e) {
                window.endCall();
                return;
            }
            
            // 2. Add self to participants if not present
            const callRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'calls', callId);
            await updateDoc(callRef, {
                participants: arrayUnion(currentUser.uid)
            });

            // 3. Listen to Signaling Channel
            const signalsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'calls', callId, 'signals');
            const q = query(signalsRef, where('to', '==', currentUser.uid));
            
            unsubscribeSignals = onSnapshot(q, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const signal = change.doc.data();
                        await handleSignal(signal, change.doc.id);
                    }
                });
            });

            // 4. Create Offers for EXISTING participants
            // We need to fetch the call doc to see who is already there
            const callSnap = await getDoc(callRef);
            const participants = callSnap.data().participants || [];
            
            for (const uid of participants) {
                if (uid === currentUser.uid) continue;
                await createPeerConnection(uid, true); // true = initiator
            }
            
            // 5. Listen to Call Meta (End call if empty, or new participants)
            unsubscribeCallMeta = onSnapshot(callRef, (snap) => {
                if (!snap.exists()) {
                    window.endCall(); // Call deleted
                    return;
                }
                const data = snap.data();
                // We could implement "polite" joiner here, but simple mesh:
                // New joiners initiate offers to us, so we just wait for signals.
                if (!data.participants || !data.participants.includes(currentUser.uid)) {
                     // We were removed?
                }
            });
            
            updateGrid();
        }

        async function createPeerConnection(remoteUid, isInitiator) {
            if (peerConnections[remoteUid]) return peerConnections[remoteUid];
            
            const pc = new RTCPeerConnection(servers);
            peerConnections[remoteUid] = pc;
            
            // Add local tracks
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            // Handle Remote Stream
            pc.ontrack = (event) => {
                const stream = event.streams[0];
                if (!remoteStreams[remoteUid]) {
                    remoteStreams[remoteUid] = stream;
                    addRemoteVideo(remoteUid, stream);
                }
            };

            // Handle ICE Candidates
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    await sendSignal({
                        type: 'candidate',
                        candidate: event.candidate.toJSON(),
                        from: currentUser.uid,
                        to: remoteUid
                    });
                }
            };

            // If Initiator, create Offer
            if (isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await sendSignal({
                    type: 'offer',
                    sdp: offer,
                    from: currentUser.uid,
                    to: remoteUid
                });
            }

            return pc;
        }

        async function handleSignal(signal, signalDocId) {
            const { type, from, sdp, candidate } = signal;
            let pc = peerConnections[from];
            
            if (type === 'offer') {
                if (!pc) pc = await createPeerConnection(from, false);
                await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await sendSignal({
                    type: 'answer',
                    sdp: answer,
                    from: currentUser.uid,
                    to: from
                });
            } else if (type === 'answer') {
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));
            } else if (type === 'candidate') {
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        async function sendSignal(payload) {
            const signalsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'calls', currentCallId, 'signals');
            await addDoc(signalsRef, {
                ...payload,
                createdAt: serverTimestamp()
            });
        }

        async function addRemoteVideo(uid, stream) {
            const container = document.getElementById('remote-videos-container');
            
            // Check if exists
            if (document.getElementById(`video-${uid}`)) return;
            
            // Fetch name
            const name = await getDisplayName(uid);
            
            const wrap = document.createElement('div');
            wrap.id = `wrapper-${uid}`;
            wrap.className = "relative bg-gray-900 rounded-2xl overflow-hidden shadow-lg border border-gray-800 w-full h-full min-h-[150px]";
            
            const vid = document.createElement('video');
            vid.id = `video-${uid}`;
            vid.autoplay = true;
            vid.playsInline = true;
            // Changed from object-cover to object-contain so full screen share is seen
            vid.className = "w-full h-full object-contain bg-black"; 
            vid.srcObject = stream;
            
            const label = document.createElement('div');
            label.className = "absolute bottom-3 left-3 bg-black/50 px-2 py-1 rounded text-white text-xs z-10";
            label.innerText = name; 
            
            wrap.appendChild(vid);
            wrap.appendChild(label);
            container.appendChild(wrap);
            
            updateGrid();
        }

        function removeRemoteVideo(uid) {
            const el = document.getElementById(`wrapper-${uid}`);
            if (el) el.remove();
            updateGrid();
        }

        function updateGrid() {
            const container = document.getElementById('remote-videos-container');
            const count = container.children.length;
            
            container.className = "video-grid p-4"; // Reset
            if (count <= 1) container.classList.add('grid-1');
            else if (count === 2) container.classList.add('grid-2');
            else if (count === 3) container.classList.add('grid-3');
            else container.classList.add('grid-4');
        }

        // --- CONTROLS ---

        window.toggleAudio = () => {
            if (localStream) {
                const track = localStream.getAudioTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    isAudioEnabled = track.enabled;
                    updateControlButtons();
                }
            }
        }

        window.toggleVideo = () => {
            if (localStream) {
                const track = localStream.getVideoTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    isVideoEnabled = track.enabled;
                    updateControlButtons();
                }
            }
        }
        
        window.toggleScreenShare = async () => {
            if (isScreenSharing) {
                // Stop Sharing
                await getLocalStream(); // Re-get camera
                const videoTrack = localStream.getVideoTracks()[0];
                
                // Replace in all PCs
                for (const uid in peerConnections) {
                    const sender = peerConnections[uid].getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                }
                
                isScreenSharing = false;
                isVideoEnabled = true; // Camera is on
            } else {
                // Start Sharing
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    
                    // Replace in all PCs
                    for (const uid in peerConnections) {
                        const sender = peerConnections[uid].getSenders().find(s => s.track.kind === 'video');
                        if (sender) sender.replaceTrack(screenTrack);
                    }
                    
                    // Update Local Preview
                    document.getElementById('localVideo').srcObject = screenStream;
                    
                    // Handle user clicking "Stop Sharing" in browser UI
                    screenTrack.onended = () => {
                        if (isScreenSharing) toggleScreenShare(); 
                    };
                    
                    isScreenSharing = true;
                } catch(e) {
                    console.error("Screen share error", e);
                }
            }
            updateControlButtons();
        }

        function updateControlButtons() {
            const audioBtn = document.getElementById('toggle-audio-btn');
            const videoBtn = document.getElementById('toggle-video-btn');
            const screenBtn = document.getElementById('toggle-screen-btn');
            
            // Audio
            if (isAudioEnabled) {
                audioBtn.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105";
                audioBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;
            } else {
                audioBtn.className = "bg-red-500 hover:bg-red-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-105";
                audioBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"></path></svg>`;
            }
            
            // Video (Camera)
            if (isVideoEnabled && !isScreenSharing) {
                videoBtn.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105";
                videoBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
            } else {
                videoBtn.className = "bg-red-500 hover:bg-red-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-105";
                videoBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"></path></svg>`;
            }

            // Screen Share
            if (isScreenSharing) {
                screenBtn.className = "bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-105";
            } else {
                screenBtn.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105";
            }
        }

        window.endCall = async () => {
            document.getElementById('call-modal').classList.add('hidden');
            
            // Clean up DB
            if (currentCallId) {
                const callRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'calls', currentCallId);
                await updateDoc(callRef, {
                    participants: arrayRemove(currentUser.uid)
                });
            }

            // Stop Local Stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // Close all Peer Connections
            for (const uid in peerConnections) {
                peerConnections[uid].close();
            }
            peerConnections = {};
            remoteStreams = {};
            
            // Remove video elements
            document.getElementById('remote-videos-container').innerHTML = '';
            
            // Unsubscribe
            if (unsubscribeSignals) unsubscribeSignals();
            if (unsubscribeCallMeta) unsubscribeCallMeta();
            
            currentCallId = null;
            isScreenSharing = false;
        }


        // --- UTILITY FUNCTIONS ---
        // (Existing util functions...)

        function sendNotification(msg) {
            if (Notification.permission !== "granted") return;
            
            const body = msg.type === 'image' ? '胴 Sent an image' : 
                         msg.type === 'file' ? '梼 Sent a file' : 
                         msg.type === 'call' ? 'T Incoming Video Call' :
                         msg.content;
            
            try {
                const notification = new Notification(`New message from ${msg.senderName}`, {
                    body: body,
                    icon: `https://ui-avatars.com/api/?name=${msg.senderName}&background=random`,
                    tag: 'chat-message' 
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            } catch (e) {
                console.error("Notification failed", e);
            }
        }
        
        window.testNotification = async () => {
            if (Notification.permission === 'default') {
                await Notification.requestPermission();
            }
            
            if (Notification.permission === 'granted') {
                new Notification("Test Notification", {
                    body: "This is a test message to verify notifications work.",
                    icon: "https://ui-avatars.com/api/?name=Test+User"
                });
                showToast("Notification sent!", "success");
            } else {
                showToast("Notifications are denied or blocked.", "error");
            }
        }

        function linkify(text, isMe) {
            if (!text) return '';
            
            const escaped = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");

            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            
            return escaped.replace(urlRegex, (url) => {
                const linkClass = isMe 
                    ? 'underline text-white font-medium hover:opacity-80' 
                    : 'underline text-blue-600 dark:text-blue-400 hover:opacity-80';
                
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="${linkClass} break-all" onclick="event.stopPropagation();">${url}</a>`;
            });
        }

        function renderMessage(msg, id, container) {
            const isMe = msg.senderId === currentUser.uid;
            const timeString = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

            const div = document.createElement('div');
            
            // SYSTEM MESSAGE HANDLING
            if (msg.type === 'system') {
                div.className = "flex w-full mb-4 justify-center";
                div.innerHTML = `
                    <div class="bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs py-1 px-3 rounded-full opacity-75">
                        ${msg.content}
                    </div>
                `;
                container.appendChild(div);
                return;
            }

            // ACTION MESSAGE HANDLING (/me)
            if (msg.type === 'action') {
                div.className = "flex w-full mb-2 justify-center px-4";
                div.innerHTML = `
                    <div class="text-sm text-gray-500 dark:text-gray-400 italic text-center">
                        <span class="font-bold text-gray-600 dark:text-gray-300">* ${msg.senderName}</span> ${msg.content}
                    </div>
                `;
                container.appendChild(div);
                return;
            }

            div.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
            
            let contentHtml = '';
            let captionHtml = '';
            
            if (msg.content && msg.content !== 'Sent an image' && msg.content !== 'Sent a file' && msg.type !== 'call') {
                const linkedContent = linkify(msg.content, isMe);
                captionHtml = `<p class="mt-2 text-sm ${isMe ? 'text-white/90' : 'text-gray-600 dark:text-gray-300'} whitespace-pre-wrap border-t ${isMe ? 'border-white/20' : 'border-gray-300 dark:border-gray-600'} pt-2">${linkedContent}</p>`;
            }

            if (msg.type === 'text') {
                contentHtml = `<p class="whitespace-pre-wrap">${linkify(msg.content, isMe)}</p>`;
            } else if (msg.type === 'image') {
                contentHtml = `
                    <div class="relative">
                        <img src="${msg.fileUrl}" class="max-w-xs md:max-w-sm rounded-lg cursor-pointer hover:opacity-95 transition-opacity" onclick="window.open('${msg.fileUrl}', '_blank')" />
                        ${captionHtml}
                    </div>`;
            } else if (msg.type === 'file') {
                contentHtml = `
                    <div>
                        <a href="${msg.fileUrl}" target="_blank" class="flex items-center gap-3 p-2 rounded-lg bg-black/5 hover:bg-black/10 dark:bg-white/5 dark:hover:bg-white/10 transition-colors">
                            <div class="bg-white dark:bg-gray-800 p-2 rounded text-blue-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium truncate">${msg.fileName || 'Download File'}</p>
                                <p class="text-xs opacity-70">Click to download</p>
                            </div>
                        </a>
                        ${captionHtml}
                    </div>`;
            } else if (msg.type === 'call') {
                const isInitiator = msg.senderId === currentUser.uid;
                contentHtml = `
                    <div class="flex flex-col items-center gap-2 min-w-[200px] p-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <span class="font-bold">Group Call</span>
                        </div>
                        <p class="text-sm opacity-90 text-center mb-2">Click below to join</p>
                        <button onclick="joinCall('${msg.callId}')" class="w-full bg-white text-blue-600 dark:bg-gray-800 dark:text-blue-400 font-bold py-2 px-4 rounded shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            Join Call
                        </button>
                    </div>
                `;
            }
            
            let replyHtml = '';
            if (msg.replyTo) {
                const safeReplyContent = msg.replyTo.content
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");

                replyHtml = `
                    <div class="border-l-4 border-blue-400 pl-3 mb-2 pt-1 pb-1 bg-gray-100 dark:bg-gray-600 rounded-r text-xs ${isMe ? 'text-white/80' : 'text-gray-600 dark:text-gray-300'}">
                        <p class="font-bold text-blue-600 dark:text-blue-300">${msg.replyTo.senderName}</p>
                        <p class="truncate">${safeReplyContent}</p>
                    </div>
                `;
            }

            let editButtonHtml = '';
            if (isMe && msg.type === 'text') {
                editButtonHtml = `
                    <button onclick="setEditTarget('${id}', \`${msg.content.replace(/`/g, '\\`')}\`)" 
                            class="text-gray-400 hover:text-yellow-500 opacity-0 group-hover:opacity-100 transition-opacity ml-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                `;
            }

            div.innerHTML = `
                <div class="max-w-[85%] md:max-w-[75%] group">
                    <div class="text-xs mb-1 flex items-center ${isMe ? 'justify-end' : 'justify-start'} gap-2">
                        ${isMe ? 
                            `<span class="text-gray-500 dark:text-gray-400">${timeString}</span>
                             <span class="font-medium text-gray-800 dark:text-gray-100">${msg.senderName}</span>` 
                            : 
                            `<span class="font-medium text-gray-800 dark:text-gray-100">${msg.senderName}</span>
                             <span class="text-gray-500 dark:text-gray-400">${timeString}</span>`
                        }
                    </div>
                    <div class="flex items-end ${isMe ? 'flex-row-reverse' : 'flex-row'} gap-1">
                        <div class="p-3 rounded-2xl ${isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-none'}">
                            ${replyHtml}
                            ${contentHtml}
                            ${msg.editedAt ? '<span class="text-xs opacity-75 mt-1 block"> (Edited)</span>' : ''}
                        </div>
                        
                        <div class="flex items-center self-center">
                            <button onclick="setReplyTarget('${id}', '${msg.senderName}', \`${msg.content.replace(/`/g, '\\`')}\`)" 
                                    class="text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity ${isMe ? 'order-2' : 'order-1'}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a5 5 0 015 5v2m-5-2V7a5 5 0 00-5 5H3"></path></svg>
                            </button>
                            ${editButtonHtml}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }
        onMessage(messaging, (payload) => {
          if (Notification.permission !== 'granted') return;
          new Notification(payload.notification?.title || 'New Message', {
            body: payload.notification?.body,
            icon: payload.notification?.icon
          });
        });

        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if ((!text && !selectedFile) || !currentChatId) return;
            
            try {
                // --- COMMAND HANDLING ---
                if (text.startsWith('/')) {
                    const args = text.split(' ');
                    const cmd = args[0].toLowerCase();
                    const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                    
                    if (cmd === '/leavechat') {
                        // Need exact object match for arrayRemove with objects, or fetch/filter
                        const chatSnap = await getDoc(chatRef);
                        if(chatSnap.exists()) {
                            const data = chatSnap.data();
                            const newParticipants = (data.participants || []).filter(p => p.uid !== currentUser.uid);
                            const newUserIds = (data.userIds || []).filter(uid => uid !== currentUser.uid);
                            
                            if (newUserIds.length === 0) {
                                await deleteDoc(chatRef);
                            } else {
                                await updateDoc(chatRef, {
                                    participants: newParticipants,
                                    userIds: newUserIds,
                                    lastMessage: `${currentUser.displayName || "User"} left the chat`
                                });
                                // Add System Message for Leaving
                                const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                                await addDoc(messagesRef, {
                                    content: `${currentUser.displayName || "User"} left the chat`,
                                    type: 'system',
                                    createdAt: serverTimestamp()
                                });
                            }
                            closeMobileChat();
                            input.value = '';
                            showToast("Left chat", "info");
                            return;
                        }
                    } else if (cmd === '/deletechat') {
                        await deleteDoc(chatRef);
                        closeMobileChat();
                        input.value = '';
                        showToast("Chat deleted", "success");
                        return;
                    } else if (cmd === '/help') {
                        showToast("Commands: /me, /shrug, /roll, /leavechat, /mute, /theme", "info");
                        input.value = '';
                        return;
                    } else if (cmd === '/mute') {
                        await updateDoc(chatRef, { mutedUserIds: arrayUnion(currentUser.uid) });
                        showToast("Chat muted", "success");
                        input.value = '';
                        return;
                    } else if (cmd === '/unmute') {
                        await updateDoc(chatRef, { mutedUserIds: arrayRemove(currentUser.uid) });
                        showToast("Chat unmuted", "success");
                        input.value = '';
                        return;
                    } else if (cmd === '/theme') {
                        if (args[1] === 'dark') {
                            rootElement.classList.add('dark');
                            await updateUserProfile({ theme: 'dark' });
                        } else if (args[1] === 'light') {
                            rootElement.classList.remove('dark');
                            await updateUserProfile({ theme: 'light' });
                        } else {
                            toggleTheme();
                        }
                        input.value = '';
                        return;
                    } else if (cmd === '/me') {
                        const actionContent = text.substring(4).trim();
                        if (actionContent) {
                            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                            await addDoc(messagesRef, {
                                content: actionContent,
                                type: 'action',
                                senderId: currentUser.uid,
                                senderName: currentUser.displayName || currentUser.email.split('@')[0],
                                createdAt: serverTimestamp()
                            });
                            input.value = '';
                            return;
                        }
                    } else if (cmd === '/shrug') {
                        const msgContent = (text.substring(7).trim() + " ¯\\_(ツ)_/¯").trim();
                        const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                        await addDoc(messagesRef, {
                            content: msgContent,
                            type: 'text',
                            senderId: currentUser.uid,
                            senderName: currentUser.displayName || currentUser.email.split('@')[0],
                            createdAt: serverTimestamp()
                        });
                        input.value = '';
                        return;
                    } else if (cmd === '/roll') {
                        const max = parseInt(args[1]) || 100;
                        const roll = Math.floor(Math.random() * max) + 1;
                        const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                        await addDoc(messagesRef, {
                            content: `🎲 ${currentUser.displayName || "User"} rolled ${roll} (1-${max})`,
                            type: 'system',
                            createdAt: serverTimestamp()
                        });
                        input.value = '';
                        return;
                    }
                }

                if (selectedFile) {
                    await uploadAndSend(selectedFile, text);
                    input.value = '';
                    cancelAttachment();
                    return; 
                }

                if (editingMessage) {
                    const messageRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages', editingMessage.id);
                    await updateDoc(messageRef, {
                        content: text,
                        editedAt: serverTimestamp()
                    });
                    cancelEdit();
                    input.value = '';
                    showToast("Message edited!", "success");

                } else {
                    const messageData = {
                        content: text,
                        type: 'text',
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName || currentUser.email.split('@')[0],
                        createdAt: serverTimestamp()
                    };
                    
                    if (replyingToMessage) {
                        messageData.replyTo = {
                            messageId: replyingToMessage.id,
                            senderName: replyingToMessage.senderName,
                            content: replyingToMessage.content
                        };
                        cancelReply();
                    }

                    // --- MENTION LOGIC ---
                    const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                    const mentionUpdates = {};
                    let hasMentions = false;
                    
                    if (currentChatParticipants) {
                        currentChatParticipants.forEach(p => {
                            if (p.uid !== currentUser.uid && text.includes(`@${p.username}`)) {
                                mentionUpdates[`mentions.${p.uid}`] = true;
                                hasMentions = true;
                            }
                        });
                    }

                    const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                    await addDoc(messagesRef, messageData);
                    
                    const updatePayload = {
                        lastMessage: text,
                        updatedAt: serverTimestamp()
                    };
                    
                    if (hasMentions) {
                        Object.assign(updatePayload, mentionUpdates);
                    }

                    await updateDoc(chatRef, updatePayload);
                    
                    input.value = '';
                }
            } catch (e) {
                console.error("Action error", e);
                showToast("Failed to send/edit", "error");
            }
        }

        document.getElementById('message-input').addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file') {
                    const blob = item.getAsFile();
                    window.handleFileUpload({ target: { files: [blob], value: '' } });
                }
            }
        });

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function uploadAndSend(file, caption) {
            if (!currentChatId) return;
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            const isImage = file.type.startsWith('image/');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const url = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, true);

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            progressBar.style.width = percentComplete + '%';
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error('Cloudinary upload failed'));
                        }
                    };

                    xhr.onerror = () => reject(new Error('Network error during upload'));
                    xhr.send(formData);
                });

                const defaultText = isImage ? 'Sent an image' : 'Sent a file';
                const finalContent = caption || defaultText;

                const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId, 'messages');
                await addDoc(messagesRef, {
                    content: finalContent,
                    type: isImage ? 'image' : 'file',
                    fileUrl: url,
                    fileName: file.name || 'uploaded-file',
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: serverTimestamp()
                });

                const chatRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', currentChatId);
                await updateDoc(chatRef, {
                    lastMessage: isImage ? '胴 Image' : '梼 File',
                    updatedAt: serverTimestamp()
                });
                
            } catch (e) {
                console.error("Upload failed", e);
                showToast("Upload failed", "error");
            } finally {
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 1000);
            }
        }
        async function registerForPushNotifications() {
          try {
            const permission = await Notification.requestPermission();
                if (permission !== 'granted') return;
            
                const swReg = await registerServiceWorker();
                if (!swReg) return;
            
                const token = await getToken(messaging, {
                  vapidKey: "BNXnkuaVm9HAkn22sCwwuejVBDCuj5kqm1PWHdqZxgcR4ARzn2D4jXe_PYVqV5K957JivEUCHBsPSdEpdSU9TGA",
                  serviceWorkerRegistration: swReg
                });
            
                if (token && currentUser) {
                  await updateDoc(
                    doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid),
                    {
                      fcmToken: token,
                      fcmUpdatedAt: serverTimestamp()
                    }
                  );
                }
              } catch (err) {
                console.error('[FCM] Registration failed', err);
              }
            }

        // --- SETTINGS & THEME ---

        window.toggleTheme = async () => {
            const isDark = rootElement.classList.contains('dark');
            if (isDark) {
                rootElement.classList.remove('dark');
                await updateUserProfile({ theme: 'light' });
            } else {
                rootElement.classList.add('dark');
                await updateUserProfile({ theme: 'dark' });
            }
        }

        window.saveSettings = async () => {
            const newUsername = document.getElementById('settings-username').value.trim();
            if (newUsername) {
                await updateUserProfile({ username: newUsername });
                currentUser.displayName = newUsername; 
                showToast("Profile updated!", "success");
                closeModal('settings-modal');
            }
        }

        window.resetPassword = async () => {
             if (!currentUser || !currentUser.email) return;

             const confirmed = confirm(`Send password reset email to ${currentUser.email}?`);
             if (!confirmed) return;

             try {
                 await sendPasswordResetEmail(auth, currentUser.email);
                 showToast("Reset email sent. Check your inbox.", "success");
             } catch (e) {
                 console.error("Reset password error", e);
                 showToast("Error sending reset email.", "error");
             }
        }

        // --- AUTH OBSERVER ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                
                const theme = await ensureUserProfile(user);
                if (theme === 'dark') rootElement.classList.add('dark');
                else rootElement.classList.remove('dark');

                const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid));
                if (snap.exists()) {
                    currentUser.displayName = snap.data().username;
                    document.getElementById('settings-username').value = snap.data().username;
                    document.getElementById('user-display-name').textContent = snap.data().username;
                    document.getElementById('user-avatar-initial').textContent = snap.data().username.substring(0,1).toUpperCase();
                }

                initChatListener();
                registerForPushNotifications();

            } else {
                currentUser = null;
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                if (unsubscribeChats) unsubscribeChats();
                if (unsubscribeMessages) unsubscribeMessages();
            }
        });

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-gray-800';
            toast.className = `fixed bottom-4 right-4 ${colors} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200 h-screen overflow-hidden font-sans text-gray-800 dark:text-gray-200">

    <div id="login-view" class="h-full flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-gray-700">
            <div class="text-center mb-8">
                <div class="h-16 w-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.013 8.013 0 01-5.699-2.399l-5.102 1.488 1.488-5.102A8.013 8.013 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Welcome Back</h1>
                <p class="text-gray-500 text-sm mt-2">Sign in to your chat</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Email</label>
                    <input type="email" id="email" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-base" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Password</label>
                    <input type="password" id="password" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white text-base" required>
                </div>
                
                <div id="login-error" class="hidden text-red-500 text-sm text-center bg-red-50 dark:bg-red-900/20 p-2 rounded"></div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/30">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <div id="main-view" class="hidden h-full flex flex-row">
        
        <!-- SIDEBAR VIEW -->
        <div id="sidebar-view" class="w-full md:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col z-10 md:flex h-full">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center flex-shrink-0">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openModal('settings-modal')">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                        <span id="user-avatar-initial">U</span>
                    </div>
                    <div>
                        <h2 id="user-display-name" class="font-bold text-sm leading-tight">User</h2>
                        <p class="text-xs text-green-500 flex items-center gap-1"><span class="block w-2 h-2 rounded-full bg-green-500"></span> Online</p>
                    </div>
                </div>
                <button onclick="openModal('settings-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>

            <div class="p-3 flex-shrink-0">
                <button onclick="openModal('new-chat-modal')" class="w-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 py-2 rounded-lg font-medium text-sm flex items-center justify-center gap-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll px-3 space-y-1 pb-4">
                </div>
        </div>

        <!-- CHAT VIEW CONTAINER -->
        <div id="chat-view-container" class="hidden md:flex flex-1 flex-col bg-gray-50 dark:bg-gray-900 relative w-full h-full">
            
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-8 text-center z-0">
                <div class="w-24 h-24 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.013 8.013 0 01-5.699-2.399l-5.102 1.488 1.488-5.102A8.013 8.013 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Select a chat to start messaging</h3>
                <p class="max-w-xs mt-2 text-sm">Or click 'New Chat' to start a conversation</p>
            </div>

            <div id="chat-interface" class="hidden flex flex-col h-full z-10 bg-white dark:bg-gray-900/50 backdrop-blur-sm w-full relative">
                <!-- Upload Progress Bar -->
                <div id="upload-progress-container" class="hidden h-1 bg-gray-200 dark:bg-gray-700 w-full absolute top-0 left-0 z-20">
                    <div id="upload-progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                </div>

                <div class="h-16 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-gray-800 shadow-sm relative flex-shrink-0">
                    <div class="flex items-center gap-2 md:gap-3 overflow-hidden">
                        <!-- MOBILE BACK BUTTON -->
                        <button onclick="closeMobileChat()" class="md:hidden mr-1 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>

                        <div class="h-10 w-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold flex-shrink-0">
                            #
                        </div>
                        <h3 id="chat-header-name" class="font-bold text-gray-800 dark:text-gray-100 truncate text-sm md:text-base">Chat Name</h3>
                    </div>
                    <div class="flex-shrink-0 flex items-center">
                        <!-- VIDEO CALL BUTTON -->
                        <button onclick="startVideoCall()" class="text-gray-500 hover:text-green-500 transition tooltip p-1 mr-2" title="Start Video Call">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                        
                        <button onclick="openModal('add-user-modal')" class="text-gray-500 hover:text-blue-500 transition tooltip p-1" title="Add person">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <button onclick="openRenameModal()" class="text-gray-500 hover:text-blue-500 transition tooltip ml-2 p-1" title="Rename chat">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button id="toggle-notifications-btn" onclick="toggleChatMute()" class="text-gray-500 hover:text-blue-500 transition tooltip ml-2 p-1" title="Mute/Unmute">
                            <!-- Icon set dynamically -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-2 custom-scroll bg-gray-50 dark:bg-gray-900 w-full relative">
                </div>
                
                <!-- Floating Scroll Button -->
                <button id="scroll-to-bottom-btn" onclick="scrollToBottomManual()" class="hidden absolute bottom-24 right-6 z-30 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 transition-all fade-in">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                </button>

                <div class="p-3 md:p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 safe-pb">
                    <!-- Preview Panel (Staging) -->
                    <div id="preview-panel" class="hidden mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                        <div id="preview-content" class="flex gap-2 items-center"></div>
                        <button onclick="cancelAttachment()" class="text-gray-400 hover:text-red-500 ml-2 bg-white dark:bg-gray-800 rounded-full p-1 shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Reply Panel -->
                    <div id="reply-panel" class="hidden mb-2 p-2 border-l-4 border-blue-500 bg-gray-50 dark:bg-gray-700/50 rounded-r flex justify-between items-center text-sm">
                        <span id="reply-content" class="text-gray-600 dark:text-gray-300 font-medium truncate"></span>
                        <button onclick="cancelReply()" class="text-gray-400 hover:text-red-500 ml-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-2 md:px-4 md:py-2 rounded-xl">
                        <label class="cursor-pointer text-gray-400 hover:text-blue-500 flex-shrink-0" title="Attach image or file">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            <input type="file" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <input id="message-input" type="text" placeholder="Type a message or use /help..." class="flex-1 bg-transparent border-none focus:ring-0 text-gray-800 dark:text-white placeholder-gray-500 text-base">
                        
                        <button id="cancel-edit-button" onclick="cancelEdit()" class="text-gray-400 hover:text-red-500 flex-shrink-0" style="display: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        
                        <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-2 transition shadow-md flex-shrink-0">
                            <svg id="send-button-icon" class="w-5 h-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                            <svg id="edit-button-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (New Chat, Add User, Rename, Settings) -->
    <div id="new-chat-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Start New Chat</h3>
            <p class="text-sm text-gray-500 mb-4">Enter the email address of the user you want to chat with.</p>
            <input type="email" id="new-chat-email" placeholder="user@example.com" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('new-chat-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="createNewChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Start Chat</button>
            </div>
        </div>
    </div>

    <div id="add-user-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Add Person to Chat</h3>
            <input type="email" id="add-user-email" placeholder="user@example.com" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('add-user-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="addUserToChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>
    
    <div id="rename-chat-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <h3 class="text-lg font-bold mb-4">Rename Chat</h3>
            <input type="text" id="rename-chat-input" placeholder="New chat name" class="w-full mb-4 p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('rename-chat-modal')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="renameChat()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Rename</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
                    <input type="text" id="settings-username" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base">
                </div>

                <div class="flex items-center justify-between py-2 border-t border-gray-100 dark:border-gray-700">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button onclick="toggleTheme()" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-blue-600 transition-colors">
                        <span class="translate-x-1 dark:translate-x-6 inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                    </button>
                </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
                <button onclick="testNotification()" class="w-full border border-blue-200 text-blue-600 py-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20">Test Notification</button>

                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
                
                <button onclick="resetPassword()" class="w-full border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    Reset Password
                </button>

                <button onclick="handleLogout(); closeModal('settings-modal')" class="w-full border border-red-200 text-red-500 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">Sign Out</button>
            </div>
        </div>
    </div>
    
    <!-- Video Call Modal -->
    <div id="call-modal" class="hidden fixed inset-0 z-[60] bg-black/95 flex flex-col items-center justify-center p-4">
        <div class="w-full h-full max-w-6xl mx-auto flex flex-col md:flex-row gap-4 items-center justify-center relative">
            
            <!-- Video Grid -->
            <div id="remote-videos-container" class="video-grid bg-gray-900 rounded-2xl overflow-hidden shadow-2xl relative border border-gray-800 w-full h-full md:w-3/4">
                <!-- Remote videos inserted here dynamically -->
            </div>

            <!-- Local Video (Side on Desktop) -->
            <div class="hidden md:block md:w-1/4 h-full flex flex-col gap-4">
                 <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700 relative aspect-video">
                    <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
                    <div class="absolute bottom-4 left-4 bg-black/50 px-3 py-1 rounded text-white text-sm">You</div>
                </div>
            </div>
             <!-- Local Video (Floating on Mobile) -->
            <div class="md:hidden absolute top-4 right-4 w-32 aspect-video bg-gray-800 rounded-lg overflow-hidden shadow-xl border border-gray-700 z-10">
                <video id="localVideoMobile" autoplay playsinline muted class="w-full h-full object-cover"></video> <!-- Mirror of localVideo via JS if needed, or just reuse id careful with dupes. Actually simplest to just move the element or rely on one element. Let's rely on CSS media queries to move 'localVideo' container. -->
            </div>


        </div>
        
        <!-- Controls -->
        <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-4 z-20">
            
            <button id="toggle-audio-btn" onclick="toggleAudio()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
            </button>
            
            <button id="toggle-video-btn" onclick="toggleVideo()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </button>

            <button id="toggle-screen-btn" onclick="toggleScreenShare()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 p-4 rounded-full shadow-lg transition-transform hover:scale-105" title="Share Screen">
               <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </button>
        
            <button onclick="endCall()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-full shadow-lg transition-transform hover:scale-105 flex items-center gap-2 font-bold ml-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-5-1.08a1 1 0 00-1.056.544l-1.204 1.126a12.92 12.92 0 01-4.706-4.706l1.126-1.204a1 1 0 00.544-1.056l-1.08-5A1 1 0 008 3H5z"></path></svg>
                End Call
            </button>
        </div>
    </div>

</body>
</html>
